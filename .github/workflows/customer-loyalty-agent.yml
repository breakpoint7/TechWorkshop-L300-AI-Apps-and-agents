name: Update Customer Loyalty Agent

on:
  push:
    branches:
      - main
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'
      - 'src/app/tools/discountLogic.py'
  workflow_dispatch:

jobs:
  update-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: ./src
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file from secret
      working-directory: ./src
      run: |
        echo "${{ secrets.ENV }}" > .env
    
    - name: Debug - Check .env file contents
      working-directory: ./src
      run: |
        echo "=== First 50 lines of .env ==="
        head -n 50 .env
        echo ""
        echo "=== Line count ==="
        wc -l .env
        echo ""
        echo "=== Checking for APPLICATIONINSIGHTS_CONNECTION_STRING ==="
        grep "APPLICATIONINSIGHTS_CONNECTION_STRING" .env || echo "NOT FOUND IN FILE"
        echo ""
        echo "=== Show with special characters visible ==="
        cat -A .env | grep -A 2 "APPLICATIONINSIGHTS" || echo "NOT FOUND"
        echo ""
        echo "=== Check if variable loads into environment ==="
        python3 -c "from dotenv import load_dotenv; import os; load_dotenv(); print('APPLICATIONINSIGHTS_CONNECTION_STRING:', os.environ.get('APPLICATIONINSIGHTS_CONNECTION_STRING', 'NOT FOUND'))"
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Run Updated Customer Loyalty Agent Initializer
      working-directory: ./src
      run: |
        python app/agents/customerLoyaltyAgent_initializer.py
    
    - name: Clean up .env file
      if: always()
      working-directory: ./src
      run: |
        rm -f .env
    
    - name: Azure Logout
      if: always()
      run: |
        az logout
